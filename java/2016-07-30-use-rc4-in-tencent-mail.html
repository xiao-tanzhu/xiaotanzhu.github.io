<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.wangjingfei.com/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.wangjingfei.com/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.wangjingfei.com/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaotanzhu.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问">
<meta property="og:type" content="article">
<meta property="og:title" content="RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问">
<meta property="og:url" content="https://www.xiaotanzhu.com/java/2016-07-30-use-rc4-in-tencent-mail.html">
<meta property="og:site_name" content="小炭猪">
<meta property="og:description" content="RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-07-29T16:00:00.000Z">
<meta property="article:modified_time" content="2016-07-29T16:00:00.000Z">
<meta property="article:author" content="Fify">
<meta property="article:tag" content="JavaMail">
<meta property="article:tag" content="JDK">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.xiaotanzhu.com/java/2016-07-30-use-rc4-in-tencent-mail.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.xiaotanzhu.com/java/2016-07-30-use-rc4-in-tencent-mail.html","path":"java/2016-07-30-use-rc4-in-tencent-mail.html","title":"RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问 | 小炭猪</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139248857-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-139248857-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="小炭猪" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="小炭猪" type="application/rss+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小炭猪</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一夕一绽一缕芳，一生一叹一痕沙</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-book fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%87%BA%E7%8E%B0"><span class="nav-number">1.</span> <span class="nav-text">问题出现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D"><span class="nav-number">2.</span> <span class="nav-text">问题定位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JavaMail%E6%8F%A1%E6%89%8B%E6%97%B6%E7%9A%84Protocol%E5%92%8CCipher"><span class="nav-number">3.</span> <span class="nav-text">JavaMail握手时的Protocol和Cipher</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="nav-number">4.</span> <span class="nav-text">解决问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%98%E6%98%AF%E7%B3%BB%E7%BB%9F%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="nav-number">5.</span> <span class="nav-text">还是系统问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="nav-number">6.</span> <span class="nav-text">解决方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E7%94%A8Java%E7%9A%84RC4%E7%AE%97%E6%B3%95"><span class="nav-number">6.1.</span> <span class="nav-text">启用Java的RC4算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E7%94%A8%E5%8D%8F%E8%AE%AE"><span class="nav-number">6.2.</span> <span class="nav-text">启用协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E7%94%A8Cipher-Scites"><span class="nav-number">6.3.</span> <span class="nav-text">启用Cipher Scites</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Fify"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Fify</p>
  <div class="site-description" itemprop="description">曾经沧海难为水，除却巫山不是云。</br>取次花丛懒回顾，半缘修道半缘君。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">115</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wangjingfei" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangjingfei" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.xiaotanzhu.com/java/2016-07-30-use-rc4-in-tencent-mail.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Fify">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小炭猪">
      <meta itemprop="description" content="曾经沧海难为水，除却巫山不是云。</br>取次花丛懒回顾，半缘修道半缘君。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问 | 小炭猪">
      <meta itemprop="description" content="RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-30 00:00:00" itemprop="dateCreated datePublished" datetime="2016-07-30T00:00:00+08:00">2016-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
    <span id="/java/2016-07-30-use-rc4-in-tencent-mail.html" class="post-meta-item leancloud_visitors" data-flag-title="RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>7月29日开始，腾讯修改了邮箱的加密方式，导致我们线上的所有的腾讯代收、代发邮件的功能全部失效。解决方法在最后，如果需要可直接跳转至<a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95">解决方法</a>一节</p>
<h3 id="问题出现"><a href="#问题出现" class="headerlink" title="问题出现"></a>问题出现</h3><p>7月29日开始，线上的所有的腾讯代收、代发邮件的功能全部失效，报<code>handshake_error</code>:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">javax.mail.MessagingException: Connect failed;</span><br><span class="line">  nested <span class="keyword">exception</span> is:</span><br><span class="line">	javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure</span><br><span class="line">	at com.sun.mail.pop3.<span class="module-access"><span class="module"><span class="identifier">POP3Store</span>.</span></span>protocol<span class="constructor">Connect(POP3Store.<span class="params">java</span>:209)</span></span><br><span class="line">	at javax.mail.<span class="module-access"><span class="module"><span class="identifier">Service</span>.</span></span>connect(<span class="module-access"><span class="module"><span class="identifier">Service</span>.</span></span>java:<span class="number">295</span>)</span><br><span class="line">	at javax.mail.<span class="module-access"><span class="module"><span class="identifier">Service</span>.</span></span>connect(<span class="module-access"><span class="module"><span class="identifier">Service</span>.</span></span>java:<span class="number">176</span>)</span><br><span class="line">	at cn.irenshi.biz.recruit.service.impl.<span class="module-access"><span class="module"><span class="identifier">RecruitReceiveMailServiceImpl</span>.</span></span>test<span class="constructor">Connect(RecruitReceiveMailServiceImpl.<span class="params">java</span>:507)</span></span><br><span class="line">	at cn.irenshi.biz.recruit.service.impl.<span class="module-access"><span class="module"><span class="identifier">RecruitReceiveMailServiceImpl</span>.</span></span>test<span class="constructor">MailConnect(RecruitReceiveMailServiceImpl.<span class="params">java</span>:534)</span></span><br><span class="line">	at sun.reflect.<span class="module-access"><span class="module"><span class="identifier">NativeMethodAccessorImpl</span>.</span></span>invoke0(Native Method)</span><br><span class="line">	at sun.reflect.<span class="module-access"><span class="module"><span class="identifier">NativeMethodAccessorImpl</span>.</span></span>invoke(<span class="module-access"><span class="module"><span class="identifier">NativeMethodAccessorImpl</span>.</span></span>java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.<span class="module-access"><span class="module"><span class="identifier">DelegatingMethodAccessorImpl</span>.</span></span>invoke(<span class="module-access"><span class="module"><span class="identifier">DelegatingMethodAccessorImpl</span>.</span></span>java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.<span class="module-access"><span class="module"><span class="identifier">Method</span>.</span></span>invoke(<span class="module-access"><span class="module"><span class="identifier">Method</span>.</span></span>java:<span class="number">497</span>)</span><br><span class="line">	at org.springframework.aop.support.<span class="module-access"><span class="module"><span class="identifier">AopUtils</span>.</span></span>invoke<span class="constructor">JoinpointUsingReflection(AopUtils.<span class="params">java</span>:302)</span></span><br><span class="line">	at org.springframework.aop.framework.<span class="module-access"><span class="module"><span class="identifier">ReflectiveMethodInvocation</span>.</span></span>invoke<span class="constructor">Joinpoint(ReflectiveMethodInvocation.<span class="params">java</span>:190)</span></span><br><span class="line">	at org.springframework.aop.framework.<span class="module-access"><span class="module"><span class="identifier">ReflectiveMethodInvocation</span>.</span></span>proceed(<span class="module-access"><span class="module"><span class="identifier">ReflectiveMethodInvocation</span>.</span></span>java:<span class="number">157</span>)<span class="operator"></span></span><br><span class="line"><span class="operator">	... </span>more</span><br><span class="line"></span><br><span class="line">Caused by: javax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure</span><br><span class="line">	at sun.security.ssl.<span class="module-access"><span class="module"><span class="identifier">Alerts</span>.</span></span>get<span class="constructor">SSLException(Alerts.<span class="params">java</span>:192)</span></span><br><span class="line">	at sun.security.ssl.<span class="module-access"><span class="module"><span class="identifier">Alerts</span>.</span></span>get<span class="constructor">SSLException(Alerts.<span class="params">java</span>:154)</span></span><br><span class="line">	at sun.security.ssl.<span class="module-access"><span class="module"><span class="identifier">SSLSocketImpl</span>.</span></span>recv<span class="constructor">Alert(SSLSocketImpl.<span class="params">java</span>:2023)</span></span><br><span class="line">	at sun.security.ssl.<span class="module-access"><span class="module"><span class="identifier">SSLSocketImpl</span>.</span></span>read<span class="constructor">Record(SSLSocketImpl.<span class="params">java</span>:1125)</span></span><br><span class="line">	at sun.security.ssl.<span class="module-access"><span class="module"><span class="identifier">SSLSocketImpl</span>.</span></span>perform<span class="constructor">InitialHandshake(SSLSocketImpl.<span class="params">java</span>:1375)</span></span><br><span class="line">	at sun.security.ssl.<span class="module-access"><span class="module"><span class="identifier">SSLSocketImpl</span>.</span></span>start<span class="constructor">Handshake(SSLSocketImpl.<span class="params">java</span>:1403)</span></span><br><span class="line">	at sun.security.ssl.<span class="module-access"><span class="module"><span class="identifier">SSLSocketImpl</span>.</span></span>start<span class="constructor">Handshake(SSLSocketImpl.<span class="params">java</span>:1387)</span></span><br><span class="line">	at com.sun.mail.util.<span class="module-access"><span class="module"><span class="identifier">SocketFetcher</span>.</span></span>configure<span class="constructor">SSLSocket(SocketFetcher.<span class="params">java</span>:549)</span></span><br><span class="line">	at com.sun.mail.util.<span class="module-access"><span class="module"><span class="identifier">SocketFetcher</span>.</span></span>create<span class="constructor">Socket(SocketFetcher.<span class="params">java</span>:354)</span></span><br><span class="line">	at com.sun.mail.util.<span class="module-access"><span class="module"><span class="identifier">SocketFetcher</span>.</span></span>get<span class="constructor">Socket(SocketFetcher.<span class="params">java</span>:237)</span></span><br><span class="line">	at com.sun.mail.pop3.Protocol.&lt;init&gt;(<span class="module-access"><span class="module"><span class="identifier">Protocol</span>.</span></span>java:<span class="number">112</span>)</span><br><span class="line">	at com.sun.mail.pop3.<span class="module-access"><span class="module"><span class="identifier">POP3Store</span>.</span></span>get<span class="constructor">Port(POP3Store.<span class="params">java</span>:260)</span></span><br><span class="line">	at com.sun.mail.pop3.<span class="module-access"><span class="module"><span class="identifier">POP3Store</span>.</span></span>protocol<span class="constructor">Connect(POP3Store.<span class="params">java</span>:205)</span><span class="operator"></span></span><br><span class="line"><span class="operator">	... </span><span class="number">132</span> more</span><br></pre></td></tr></table></figure>
<p>记得当时用客户端链接腾讯的企业邮箱时，报证书警告，警告原因是<code>pop.exmail.qq.com</code>这个域名使用了<code>pop.qq.com</code>这个证书，应该是为了省钱吧。但是当用QQ个人邮箱连接的时候，确实使用了正确的证书，那错误原因应该不同。</p>
<h3 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h3><p>把问题交给做邮箱连接的同事，结果同事很快告诉我，他在windows上运行代码完全没有任何问题，并且JDK都用了相同的版本：1.8.0_u60。难道这个错误和系统相关？<br>打开Thunderbird尝试连接腾讯邮箱，发现一切也正常。可以断定这个问题不是系统相关的，问题一定出在我们的代码中。网上搜了一些<code>handshake_failure</code>相关的原因如下（<a target="_blank" rel="noopener" href="http://stackoverflow.com/a/6353956" title="StackOverflow">StackOverflow</a>）：</p>
<blockquote>
<ul>
<li>Incompatible cipher suites in use by the client and the server. This would require the client to use (or enable) a cipher suite that is supported by the server.</li>
<li>Incompatible versions of SSL in use (the server might accept only TLS v1, while the client is capable of only using SSL v3). Again, the client might have to ensure that it uses a compatible version of the SSL/TLS protocol.</li>
<li>Incomplete trust path for the server certificate; the server’s certificate is probably not trusted by the client. This would usually result in a more verbose error, but it is quite possible. Usually the fix is to import the server’s CA certificate into the client’s trust store.</li>
<li>The cerificate is issued for a different domain. Again, this would have resulted in a more verbose message, but I’ll state the fix here in case this is the cause. The resolution in this case would be get the server (it does not appear to be yours) to use the correct certificate.</li>
</ul>
</blockquote>
<p>问题来了，如果以上是问题所在的话，一定会有一些错误信息输出，但为什么在我的系统中没有任何输出？</p>
<p>想到telnet，因为一般测试邮箱连接都直接使用telnet明文测试一下。当然这个想法是不可行的，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fify@fify-PC:~$ telnet pop.qq.com 995</span><br><span class="line">Trying 163.177.72.198...</span><br><span class="line">Connected to pop.qq.com.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br></pre></td></tr></table></figure>
<p>没有办法输入任何东西，原因也很简单，995端口使用了加密。（这里犯迷糊了，现在握手错误就是因为加密问题…）</p>
<p>换一个方式连接POP邮箱：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect pop.qq.com:995</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">CONNECTED(00000003)</span></span><br><span class="line"><span class="string">depth=2</span> <span class="string">C</span> <span class="string">=</span> <span class="string">US,</span> <span class="string">O</span> <span class="string">=</span> <span class="string">GeoTrust</span> <span class="string">Inc.,</span> <span class="string">CN</span> <span class="string">=</span> <span class="string">GeoTrust</span> <span class="string">Global</span> <span class="string">CA</span></span><br><span class="line"><span class="string">verify</span> <span class="string">return:1</span></span><br><span class="line"><span class="string">depth=1</span> <span class="string">C</span> <span class="string">=</span> <span class="string">US,</span> <span class="string">O</span> <span class="string">=</span> <span class="string">GeoTrust</span> <span class="string">Inc.,</span> <span class="string">CN</span> <span class="string">=</span> <span class="string">GeoTrust</span> <span class="string">SSL</span> <span class="string">CA</span> <span class="bullet">-</span> <span class="string">G3</span></span><br><span class="line"><span class="string">verify</span> <span class="string">return:1</span></span><br><span class="line"><span class="string">depth=0</span> <span class="string">C</span> <span class="string">=</span> <span class="string">CN,</span> <span class="string">ST</span> <span class="string">=</span> <span class="string">Guangdong,</span> <span class="string">L</span> <span class="string">=</span> <span class="string">Shenzhen,</span> <span class="string">O</span> <span class="string">=</span> <span class="string">Shenzhen</span> <span class="string">Tencent</span> <span class="string">Computer</span> <span class="string">Systems</span> <span class="string">Company</span> <span class="string">Limited,</span> <span class="string">OU</span> <span class="string">=</span> <span class="string">R&amp;D,</span> <span class="string">CN</span> <span class="string">=</span> <span class="string">pop.qq.com</span></span><br><span class="line"><span class="string">verify</span> <span class="string">return:1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">Certificate</span> <span class="string">chain</span></span><br><span class="line"> <span class="number">0</span> <span class="string">s:/C=CN/ST=Guangdong/L=Shenzhen/O=Shenzhen</span> <span class="string">Tencent</span> <span class="string">Computer</span> <span class="string">Systems</span> <span class="string">Company</span> <span class="string">Limited/OU=R&amp;D/CN=pop.qq.com</span></span><br><span class="line">   <span class="string">i:/C=US/O=GeoTrust</span> <span class="string">Inc./CN=GeoTrust</span> <span class="string">SSL</span> <span class="string">CA</span> <span class="bullet">-</span> <span class="string">G3</span></span><br><span class="line"> <span class="number">1</span> <span class="string">s:/C=US/O=GeoTrust</span> <span class="string">Inc./CN=GeoTrust</span> <span class="string">SSL</span> <span class="string">CA</span> <span class="bullet">-</span> <span class="string">G3</span></span><br><span class="line">   <span class="string">i:/C=US/O=GeoTrust</span> <span class="string">Inc./CN=GeoTrust</span> <span class="string">Global</span> <span class="string">CA</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">Server</span> <span class="string">certificate</span></span><br><span class="line"><span class="string">-----BEGIN</span> <span class="string">CERTIFICATE-----</span></span><br><span class="line"><span class="string">MIIGbzCCBVegAwIBAgIQZlTnxqFc/rVo50RzuVnejDANBgkqhkiG9w0BAQsFADBE</span></span><br><span class="line"><span class="string">MQswCQYDVQQGEwJVUzEWMBQGA1UEChMNR2VvVHJ1c3QgSW5jLjEdMBsGA1UEAxMU</span></span><br><span class="line"><span class="string">R2VvVHJ1c3QgU1NMIENBIC0gRzMwHhcNMTYwMTI3MDAwMDAwWhcNMTYxMDIzMjM1</span></span><br><span class="line"><span class="string">OTU5WjCBkzELMAkGA1UEBhMCQ04xEjAQBgNVBAgTCUd1YW5nZG9uZzERMA8GA1UE</span></span><br><span class="line"><span class="string">BxQIU2hlbnpoZW4xOjA4BgNVBAoUMVNoZW56aGVuIFRlbmNlbnQgQ29tcHV0ZXIg</span></span><br><span class="line"><span class="string">U3lzdGVtcyBDb21wYW55IExpbWl0ZWQxDDAKBgNVBAsUA1ImRDETMBEGA1UEAxQK</span></span><br><span class="line"><span class="string">cG9wLnFxLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALeSY7Vb</span></span><br><span class="line"><span class="string">60Cvv7P2O+zhaZnqlz/KFs//DH4It3xmyMPFOPUFopzN1h8n3/4FPqGBtqEEuWBE</span></span><br><span class="line"><span class="string">/o7soZT30E8bw30Tl07VOcYm/fPKi1pyro3hNEdLi5Wlta9fKxDAvw0U3clSq39R</span></span><br><span class="line"><span class="string">qihYIDAA3QrDuqI54gULa5IZnqM16A9VBULPfIDaXbdgaAIJ5Ak92nC13YcdQYuv</span></span><br><span class="line"><span class="string">egL6jOWSKzCRTqeRAg+6dWkfce1+gAOCuCUDgAso2EJ+k9nFe/LAMMGdGbe4KI9H</span></span><br><span class="line"><span class="string">CwpDCMo+2k2u4SQtXOmuYke7nNmRnpJeL3qZnGWsqT7l3N0mYCc/+3zcMfAcmyuo</span></span><br><span class="line"><span class="string">H90stoWF/G2T2rcCAwEAAaOCAwswggMHMIIBggYDVR0RBIIBeTCCAXWCCm14Mi5x</span></span><br><span class="line"><span class="string">cS5jb22CEmltYXAuZXhtYWlsLnFxLmNvbYISdXBsb2FkLm1haWwucXEuY29tgg90</span></span><br><span class="line"><span class="string">ZWwubWFpbC5xcS5jb22CFGh3c210cC5leG1haWwucXEuY29tgg9tb2IubWFpbC5x</span></span><br><span class="line"><span class="string">cS5jb22CEXJ0eC5leG1haWwucXEuY29tgg1teGJpejIucXEuY29tgg1teGJpejEu</span></span><br><span class="line"><span class="string">cXEuY29tgg5oay5tYWlsLnFxLmNvbYIOY2xvdWRteC5xcS5jb22CFGh3aW1hcC5l</span></span><br><span class="line"><span class="string">eG1haWwucXEuY29tggpteDEucXEuY29tghJzbXRwLmV4bWFpbC5xcS5jb22CEXBv</span></span><br><span class="line"><span class="string">cC5leG1haWwucXEuY29tghNod3BvcC5leG1haWwucXEuY29tggpteDMucXEuY29t</span></span><br><span class="line"><span class="string">ggtzbXRwLnFxLmNvbYIKZGF2LnFxLmNvbYIJZXgucXEuY29tgg9jbmMubWFpbC5x</span></span><br><span class="line"><span class="string">cS5jb22CC2ltYXAucXEuY29tggpwb3AucXEuY29tMAkGA1UdEwQCMAAwDgYDVR0P</span></span><br><span class="line"><span class="string">AQH/BAQDAgWgMCsGA1UdHwQkMCIwIKAeoByGGmh0dHA6Ly9nbi5zeW1jYi5jb20v</span></span><br><span class="line"><span class="string">Z24uY3JsMIGdBgNVHSAEgZUwgZIwgY8GBmeBDAECAjCBhDA/BggrBgEFBQcCARYz</span></span><br><span class="line"><span class="string">aHR0cHM6Ly93d3cuZ2VvdHJ1c3QuY29tL3Jlc291cmNlcy9yZXBvc2l0b3J5L2xl</span></span><br><span class="line"><span class="string">Z2FsMEEGCCsGAQUFBwICMDUMM2h0dHBzOi8vd3d3Lmdlb3RydXN0LmNvbS9yZXNv</span></span><br><span class="line"><span class="string">dXJjZXMvcmVwb3NpdG9yeS9sZWdhbDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYB</span></span><br><span class="line"><span class="string">BQUHAwIwHwYDVR0jBBgwFoAU0m/3lvSFP3I8MH0j2oV4m6N8WnwwVwYIKwYBBQUH</span></span><br><span class="line"><span class="string">AQEESzBJMB8GCCsGAQUFBzABhhNodHRwOi8vZ24uc3ltY2QuY29tMCYGCCsGAQUF</span></span><br><span class="line"><span class="string">BzAChhpodHRwOi8vZ24uc3ltY2IuY29tL2duLmNydDANBgkqhkiG9w0BAQsFAAOC</span></span><br><span class="line"><span class="string">AQEAvta4aGvK5qe31ZnLbmtblhgLD11dAdSom3sEnkF8UHtoi+gPiHBmHy1t39Du</span></span><br><span class="line"><span class="string">2w+5aeriqwsetdDNuAhh6ckKJhGjc9ochWw2lvyuHPko8sSDdBd/oUYBh60lREwB</span></span><br><span class="line"><span class="string">DoAi7x37QIjia4yprFCNs/+bV+bee+2nijeNYibgwLQ+5jZL89jC6BVXxLSTenVw</span></span><br><span class="line"><span class="string">B2bzQPauNo+DOsB6ubY/i5r9p2E1DHAO9AluN/epJZ1gwZhYlOey71s59341w/ql</span></span><br><span class="line"><span class="string">ZJImDrWch+Gj1ZgnXWnttgOSafqynPA6VtiFyYGF4zLboxIkNiyuwj+ZzuugV97z</span></span><br><span class="line"><span class="string">IurYVE9FA7vTlfeJhAkG2gIwsA==</span></span><br><span class="line"><span class="string">-----END</span> <span class="string">CERTIFICATE-----</span></span><br><span class="line"><span class="string">subject=/C=CN/ST=Guangdong/L=Shenzhen/O=Shenzhen</span> <span class="string">Tencent</span> <span class="string">Computer</span> <span class="string">Systems</span> <span class="string">Company</span> <span class="string">Limited/OU=R&amp;D/CN=pop.qq.com</span></span><br><span class="line"><span class="string">issuer=/C=US/O=GeoTrust</span> <span class="string">Inc./CN=GeoTrust</span> <span class="string">SSL</span> <span class="string">CA</span> <span class="bullet">-</span> <span class="string">G3</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="literal">No</span> <span class="string">client</span> <span class="string">certificate</span> <span class="string">CA</span> <span class="string">names</span> <span class="string">sent</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">SSL</span> <span class="string">handshake</span> <span class="string">has</span> <span class="string">read</span> <span class="number">3070 </span><span class="string">bytes</span> <span class="string">and</span> <span class="string">written</span> <span class="number">619</span> <span class="string">bytes</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">New,</span> <span class="string">TLSv1/SSLv3,</span> <span class="string">Cipher</span> <span class="string">is</span> <span class="string">RC4-SHA</span></span><br><span class="line"><span class="string">Server</span> <span class="string">public</span> <span class="string">key</span> <span class="string">is</span> <span class="number">2048 </span><span class="string">bit</span></span><br><span class="line"><span class="string">Secure</span> <span class="string">Renegotiation</span> <span class="string">IS</span> <span class="string">supported</span></span><br><span class="line"><span class="attr">Compression:</span> <span class="string">NONE</span></span><br><span class="line"><span class="attr">Expansion:</span> <span class="string">NONE</span></span><br><span class="line"><span class="literal">No</span> <span class="string">ALPN</span> <span class="string">negotiated</span></span><br><span class="line"><span class="attr">SSL-Session:</span></span><br><span class="line">    <span class="attr">Protocol  :</span> <span class="string">TLSv1.2</span></span><br><span class="line">    <span class="attr">Cipher    :</span> <span class="string">RC4-SHA</span></span><br><span class="line">    <span class="attr">Session-ID:</span> <span class="string">E278833690D2364F44B8E2B6D3F3708888411AD55298F02A0710C73FE229BBE9</span></span><br><span class="line">    <span class="attr">Session-ID-ctx:</span> </span><br><span class="line">    <span class="attr">Master-Key:</span> <span class="string">AF8A9394C87F52872A31DCC5ED62FF5F97B6F621CC9337E151D5F6229E9F231626F10B392A1938669EE72911ABD860D6</span></span><br><span class="line">    <span class="attr">Key-Arg   :</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">PSK identity:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">PSK identity hint:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">SRP username:</span> <span class="string">None</span></span><br><span class="line">    <span class="attr">TLS session ticket lifetime hint:</span> <span class="number">300</span> <span class="string">(seconds)</span></span><br><span class="line">    <span class="attr">TLS session ticket:</span></span><br><span class="line">    <span class="number">0000</span> <span class="bullet">-</span> <span class="string">6c</span> <span class="number">30</span> <span class="number">25</span> <span class="string">d9</span> <span class="number">92</span> <span class="number">71</span> <span class="number">25</span> <span class="string">7c-3e</span> <span class="string">bd</span> <span class="string">7b</span> <span class="string">e6</span> <span class="string">e2</span> <span class="string">a5</span> <span class="number">13</span> <span class="string">d1</span>   <span class="string">l0%..q%|&gt;.&#123;.....</span></span><br><span class="line">    <span class="number">0010</span> <span class="bullet">-</span> <span class="string">9b</span> <span class="string">f9</span> <span class="number">61</span> <span class="string">e6</span> <span class="string">3d</span> <span class="string">dc</span> <span class="string">e6</span> <span class="string">ea-96</span> <span class="string">9d</span> <span class="number">04</span> <span class="number">02</span> <span class="string">ea</span> <span class="string">6f</span> <span class="number">68</span> <span class="string">0f</span>   <span class="string">..a.=........oh.</span></span><br><span class="line">    <span class="number">0020</span> <span class="bullet">-</span> <span class="number">18</span> <span class="string">a3</span> <span class="string">a3</span> <span class="string">e6</span> <span class="number">39</span> <span class="number">02</span> <span class="string">b9</span> <span class="string">d2-dd</span> <span class="string">d1</span> <span class="string">2c</span> <span class="number">18</span> <span class="string">6d</span> <span class="string">9c</span> <span class="number">87</span> <span class="string">e5</span>   <span class="string">....9.....,.m...</span></span><br><span class="line">    <span class="number">0030</span> <span class="bullet">-</span> <span class="number">31</span> <span class="string">a9</span> <span class="number">53</span> <span class="string">a0</span> <span class="string">6c</span> <span class="string">2d</span> <span class="string">4c</span> <span class="string">b6-d4</span> <span class="string">d6</span> <span class="number">35</span> <span class="string">ef</span> <span class="string">d9</span> <span class="number">04</span> <span class="string">b0</span> <span class="string">b9</span>   <span class="number">1.</span><span class="string">S.l-L...5.....</span></span><br><span class="line">    <span class="number">0040</span> <span class="bullet">-</span> <span class="number">70</span> <span class="string">af</span> <span class="number">82</span> <span class="number">74</span> <span class="string">1e</span> <span class="string">1d</span> <span class="number">26</span> <span class="string">9a-00</span> <span class="number">00</span> <span class="string">6b</span> <span class="number">90</span> <span class="string">2e</span> <span class="string">eb</span> <span class="number">56</span> <span class="string">e9</span>   <span class="string">p..t..&amp;...k...V.</span></span><br><span class="line">    <span class="number">0050</span> <span class="bullet">-</span> <span class="string">d8</span> <span class="string">f4</span> <span class="string">cd</span> <span class="number">56</span> <span class="string">d5</span> <span class="string">c2</span> <span class="number">02</span> <span class="number">80</span><span class="string">-0e</span> <span class="string">d9</span> <span class="number">15</span> <span class="string">e5</span> <span class="string">2a</span> <span class="string">b9</span> <span class="string">1f</span> <span class="string">f3</span>   <span class="string">...V........*...</span></span><br><span class="line">    <span class="number">0060</span> <span class="bullet">-</span> <span class="string">8a</span> <span class="number">90</span> <span class="string">7b</span> <span class="string">c0</span> <span class="number">72</span> <span class="string">6e</span> <span class="string">c5</span> <span class="string">2a-04</span> <span class="string">2c</span> <span class="number">91</span> <span class="string">1c</span> <span class="number">11</span> <span class="string">fd</span> <span class="number">40</span> <span class="string">ba</span>   <span class="string">..&#123;.rn.*.,....@.</span></span><br><span class="line">    <span class="number">0070</span> <span class="bullet">-</span> <span class="number">38</span> <span class="string">fb</span> <span class="string">db</span> <span class="string">fb</span> <span class="string">eb</span> <span class="string">b7</span> <span class="number">65</span> <span class="string">e1-e1</span> <span class="number">51</span> <span class="string">1a</span> <span class="string">e3</span> <span class="string">b2</span> <span class="string">f3</span> <span class="number">64</span> <span class="string">4e</span>   <span class="number">8</span><span class="string">.....e..Q....dN</span></span><br><span class="line">    <span class="number">0080</span> <span class="bullet">-</span> <span class="number">54</span> <span class="string">6b</span> <span class="string">5f</span> <span class="string">0e</span> <span class="string">9d</span> <span class="string">be</span> <span class="number">40</span> <span class="number">60</span><span class="string">-dd</span> <span class="number">68</span> <span class="string">8f</span> <span class="number">52</span> <span class="string">5d</span> <span class="string">f3</span> <span class="number">48</span> <span class="number">36</span>   <span class="string">Tk_...@`.h.R].H6</span></span><br><span class="line">    <span class="number">0090</span> <span class="bullet">-</span> <span class="number">40</span> <span class="string">7b</span> <span class="number">11</span> <span class="number">68</span> <span class="number">10</span> <span class="string">7f</span> <span class="string">7d</span> <span class="string">e2-d6</span> <span class="number">93</span> <span class="number">19</span> <span class="number">48</span> <span class="number">42</span> <span class="string">f0</span> <span class="string">da</span> <span class="string">bc</span>   <span class="string">@&#123;.h..&#125;....HB...</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Start Time:</span> <span class="number">1470455760</span></span><br><span class="line">    <span class="attr">Timeout   :</span> <span class="number">300</span> <span class="string">(sec)</span></span><br><span class="line">    <span class="attr">Verify return code:</span> <span class="number">0</span> <span class="string">(ok)</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">+OK</span> <span class="string">QQMail</span> <span class="string">POP3</span> <span class="string">Server</span> <span class="string">v1.0</span> <span class="string">Service</span> <span class="string">Ready(QQMail</span> <span class="string">v2.0)</span></span><br></pre></td></tr></table></figure>
<p>注意到以下片段</p>
<blockquote>
<p>SSL-Session:<br>   Protocol  : TLSv1.2<br>   Cipher    : RC4-SHA</p>
</blockquote>
<p>可以看到，加密使用的协议是<code>TLSv1.2</code>，Cipher使用的是<code>RC4-SHA</code>。</p>
<p>那么问题是出在这两个地方吗？</p>
<h3 id="JavaMail握手时的Protocol和Cipher"><a href="#JavaMail握手时的Protocol和Cipher" class="headerlink" title="JavaMail握手时的Protocol和Cipher"></a>JavaMail握手时的Protocol和Cipher</h3><p>在Java启动中增加参数<code>-Djavax.net.debug=all</code>可以开启加密协议的调试模式。详情可以参考<a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/6/docs/technotes/guides/security/jsse/ReadDebug.html">Oracle提供的文档</a>。</p>
<p>开启之后，连接邮箱握手的过程中打出了以下日志：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">trigger seeding of SecureRandom</span><br><span class="line">done seeding SecureRandom</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA256</span><br><span class="line">Ignoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA</span><br><span class="line">Ignoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">Allow unsafe renegotiation: false</span><br><span class="line">Allow legacy hello messages: true</span><br><span class="line">Is initial handshake: true</span><br><span class="line">Is secure renegotiation: false</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_RSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256 for TLSv1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">Ignoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256 for TLSv1.1</span><br><span class="line">%% No cached client session</span><br><span class="line">*** ClientHello, TLSv1.2</span><br><span class="line">RandomCookie:  GMT: 1453331365 bytes = &#123; 172, 246, 197, 31, 208, 63, 31, 30, 107, 70, 211, 242, 90, 243, 100, 108, 44, 192, 70, 4, 238, 84, 176, 59, 5, 75, 162, 127 &#125;</span><br><span class="line">Session ID:  &#123;&#125;</span><br><span class="line">Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]</span><br><span class="line">Compression Methods:  &#123; 0 &#125;</span><br><span class="line">Extension elliptic_curves, curve names: &#123;<span class="attribute">secp256r1, sect163k1, sect163r2, secp192r1, secp224r1, sect233k1, sect233r1, sect283k1, sect283r1, secp384r1, sect409k1, sect409r1, secp521r1, sect571k1, sect571r1, secp160k1, secp160r1, secp160r2, sect163r1, secp192k1, sect193r1, sect193r2, secp224k1, sect239k1, secp256k1&#125;</span></span><br><span class="line"><span class="attribute">Extension ec_point_formats, formats</span>: [uncompressed]</span><br><span class="line">Extension signature_algorithms, signature_algorithms: SHA512withECDSA, SHA512withRSA, SHA384withECDSA, SHA384withRSA, SHA256withECDSA, SHA256withRSA, SHA224withECDSA, SHA224withRSA, SHA1withECDSA, SHA1withRSA, SHA1withDSA, MD5withRSA</span><br><span class="line">Extension server_name, server_name: [type=host_name (0), value=pop<span class="variable">.qq</span><span class="variable">.com</span>]</span><br><span class="line">***</span><br><span class="line">[write] MD5 and SHA1 hashes:  len = 214</span><br><span class="line">0000: 01 00 00 D2 03 03 57 A0   14 A5 AC F6 C5 1F D0 3F  .....<span class="variable">.W</span>........?</span><br><span class="line">0010: 1F 1E 6B 46 D3 F2 5A F3   64 6C 2C C0 46 04 EE 54  .<span class="variable">.kF</span>.<span class="variable">.Z</span><span class="variable">.dl</span>,<span class="variable">.F</span>.<span class="variable">.T</span></span><br><span class="line">0020: B0 3B 05 4B A2 7F 00 00   3A C0 23 C0 27 00 3C C0  .;.<span class="attribute">K....</span>:.#.&#x27;.&lt;.</span><br><span class="line">0030: 25 C0 29 00 67 00 40 C0   09 C0 13 00 2F C0 04 C0  %.)<span class="variable">.g</span>.@...../...</span><br><span class="line">0040: 0E 00 33 00 32 C0 2B C0   2F 00 9C C0 2D C0 31 00  ..3.2.+./..<span class="variable">.-</span>.1.</span><br><span class="line">0050: 9E 00 A2 C0 08 C0 12 00   0A C0 03 C0 0D 00 16 00  ................</span><br><span class="line">0060: 13 00 FF 01 00 00 6F 00   0A 00 34 00 32 00 17 00  .....<span class="variable">.o</span>...4.2...</span><br><span class="line">0070: 01 00 03 00 13 00 15 00   06 00 07 00 09 00 0A 00  ................</span><br><span class="line">0080: 18 00 0B 00 0C 00 19 00   0D 00 0E 00 0F 00 10 00  ................</span><br><span class="line">0090: 11 00 02 00 12 00 04 00   05 00 14 00 08 00 16 00  ................</span><br><span class="line">00A0: 0B 00 02 01 00 00 0D 00   1A 00 18 06 03 06 01 05  ................</span><br><span class="line">00B0: 03 05 01 04 03 04 01 03   03 03 01 02 03 02 01 02  ................</span><br><span class="line">00C0: 02 01 01 00 00 00 0F 00   0D 00 00 0A 70 6F 70 2E  ...........<span class="variable">.pop</span>.</span><br><span class="line">00D0: 71 71 2E 63 6F 6D                                  qq<span class="variable">.com</span></span><br><span class="line">http-nio-8080-exec-2, WRITE: TLSv1.2 Handshake, length = 214</span><br><span class="line">[Raw write]: length = 219</span><br><span class="line">0000: 16 03 03 00 D6 01 00 00   D2 03 03 57 A0 14 A5 AC  ..........<span class="variable">.W</span>....</span><br><span class="line">0010: F6 C5 1F D0 3F 1F 1E 6B   46 D3 F2 5A F3 64 6C 2C  ....?.<span class="variable">.kF</span>.<span class="variable">.Z</span><span class="variable">.dl</span>,</span><br><span class="line">0020: C0 46 04 EE 54 B0 3B 05   4B A2 7F 00 00 3A C0 23  <span class="variable">.F</span>.<span class="variable">.T</span>.;.<span class="attribute">K....</span>:.#</span><br><span class="line">0030: C0 27 00 3C C0 25 C0 29   00 67 00 40 C0 09 C0 13  .&#x27;.&lt;.%.)<span class="variable">.g</span>.@....</span><br><span class="line">0040: 00 2F C0 04 C0 0E 00 33   00 32 C0 2B C0 2F 00 9C  ./.....3.2.+./..</span><br><span class="line">0050: C0 2D C0 31 00 9E 00 A2   C0 08 C0 12 00 0A C0 03  <span class="variable">.-</span>.1............</span><br><span class="line">0060: C0 0D 00 16 00 13 00 FF   01 00 00 6F 00 0A 00 34  ..........<span class="variable">.o</span>...4</span><br><span class="line">0070: 00 32 00 17 00 01 00 03   00 13 00 15 00 06 00 07  .2..............</span><br><span class="line">0080: 00 09 00 0A 00 18 00 0B   00 0C 00 19 00 0D 00 0E  ................</span><br><span class="line">0090: 00 0F 00 10 00 11 00 02   00 12 00 04 00 05 00 14  ................</span><br><span class="line">00A0: 00 08 00 16 00 0B 00 02   01 00 00 0D 00 1A 00 18  ................</span><br><span class="line">00B0: 06 03 06 01 05 03 05 01   04 03 04 01 03 03 03 01  ................</span><br><span class="line">00C0: 02 03 02 01 02 02 01 01   00 00 00 0F 00 0D 00 00  ................</span><br><span class="line">00D0: 0A 70 6F 70 2E 71 71 2E   63 6F 6D                 <span class="variable">.pop</span><span class="variable">.qq</span><span class="variable">.com</span></span><br><span class="line">javax<span class="variable">.mail</span><span class="variable">.MessagingException</span>: Connect failed;</span><br><span class="line">  <span class="attribute">nested exception is</span>:</span><br><span class="line">	javax<span class="variable">.net</span><span class="variable">.ssl</span><span class="variable">.SSLHandshakeException</span>: Received fatal alert: handshake_failure</span><br><span class="line">	at com<span class="variable">.sun</span><span class="variable">.mail</span><span class="variable">.pop</span>3<span class="variable">.POP</span>3Store<span class="variable">.protocolConnect</span>(POP3Store<span class="variable">.java</span>:209)</span><br><span class="line">	at javax<span class="variable">.mail</span><span class="variable">.Service</span><span class="variable">.connect</span>(Service<span class="variable">.java</span>:295)</span><br><span class="line">	at javax<span class="variable">.mail</span><span class="variable">.Service</span><span class="variable">.connect</span>(Service<span class="variable">.java</span>:176)</span><br><span class="line">	at cn<span class="variable">.irenshi</span><span class="variable">.biz</span><span class="variable">.recruit</span><span class="variable">.service</span><span class="variable">.impl</span><span class="variable">.RecruitReceiveMailServiceImpl</span><span class="variable">.testConnect</span>(RecruitReceiveMailServiceImpl<span class="variable">.java</span>:507)</span><br><span class="line">	at cn<span class="variable">.irenshi</span><span class="variable">.biz</span><span class="variable">.recruit</span><span class="variable">.service</span><span class="variable">.impl</span><span class="variable">.RecruitReceiveMailServiceImpl</span><span class="variable">.testMailConnect</span>(RecruitReceiveMailServiceImpl<span class="variable">.java</span>:534)</span><br><span class="line">	at sun<span class="variable">.reflect</span><span class="variable">.NativeMethodAccessorImpl</span><span class="variable">.invoke</span>0(Native Method)</span><br><span class="line">	at sun<span class="variable">.reflect</span><span class="variable">.NativeMethodAccessorImpl</span><span class="variable">.invoke</span>(NativeMethodAccessorImpl<span class="variable">.java</span>:62)</span><br><span class="line">	at sun<span class="variable">.reflect</span><span class="variable">.DelegatingMethodAccessorImpl</span><span class="variable">.invoke</span>(DelegatingMethodAccessorImpl<span class="variable">.java</span>:43)</span><br><span class="line">	at java<span class="variable">.lang</span><span class="variable">.reflect</span><span class="variable">.Method</span><span class="variable">.invoke</span>(Method<span class="variable">.java</span>:497)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.support</span><span class="variable">.AopUtils</span><span class="variable">.invokeJoinpointUsingReflection</span>(AopUtils<span class="variable">.java</span>:302)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.ReflectiveMethodInvocation</span><span class="variable">.invokeJoinpoint</span>(ReflectiveMethodInvocation<span class="variable">.java</span>:190)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.ReflectiveMethodInvocation</span><span class="variable">.proceed</span>(ReflectiveMethodInvocation<span class="variable">.java</span>:157)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.transaction</span><span class="variable">.interceptor</span><span class="variable">.TransactionInterceptor</span>$1<span class="variable">.proceedWithInvocation</span>(TransactionInterceptor<span class="variable">.java</span>:99)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.transaction</span><span class="variable">.interceptor</span><span class="variable">.TransactionAspectSupport</span><span class="variable">.invokeWithinTransaction</span>(TransactionAspectSupport<span class="variable">.java</span>:281)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.transaction</span><span class="variable">.interceptor</span><span class="variable">.TransactionInterceptor</span><span class="variable">.invoke</span>(TransactionInterceptor<span class="variable">.java</span>:96)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.ReflectiveMethodInvocation</span><span class="variable">.proceed</span>(ReflectiveMethodInvocation<span class="variable">.java</span>:179)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.JdkDynamicAopProxy</span><span class="variable">.invoke</span>(JdkDynamicAopProxy<span class="variable">.java</span>:207)</span><br><span class="line">	at com<span class="variable">.sun</span><span class="variable">.proxy</span>.$Proxy1083<span class="variable">.testMailConnect</span>(Unknown Source)</span><br><span class="line">	at cn<span class="variable">.irenshi</span><span class="variable">.web</span><span class="variable">.controller</span><span class="variable">.recruit</span><span class="variable">.RecruitReceiveMailController</span><span class="variable">.testMailConnect</span>(RecruitReceiveMailController<span class="variable">.java</span>:116)</span><br><span class="line">	at cn<span class="variable">.irenshi</span><span class="variable">.web</span><span class="variable">.controller</span><span class="variable">.recruit</span><span class="variable">.RecruitReceiveMailController</span>$$FastClassBySpringCGLIB$$4d626811<span class="variable">.invoke</span>(&lt;generated&gt;)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.cglib</span><span class="variable">.proxy</span><span class="variable">.MethodProxy</span><span class="variable">.invoke</span>(MethodProxy<span class="variable">.java</span>:204)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.CglibAopProxy</span>$CglibMethodInvocation<span class="variable">.invokeJoinpoint</span>(CglibAopProxy<span class="variable">.java</span>:717)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.ReflectiveMethodInvocation</span><span class="variable">.proceed</span>(ReflectiveMethodInvocation<span class="variable">.java</span>:157)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.security</span><span class="variable">.access</span><span class="variable">.intercept</span><span class="variable">.aopalliance</span><span class="variable">.MethodSecurityInterceptor</span><span class="variable">.invoke</span>(MethodSecurityInterceptor<span class="variable">.java</span>:68)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.ReflectiveMethodInvocation</span><span class="variable">.proceed</span>(ReflectiveMethodInvocation<span class="variable">.java</span>:179)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.interceptor</span><span class="variable">.ExposeInvocationInterceptor</span><span class="variable">.invoke</span>(ExposeInvocationInterceptor<span class="variable">.java</span>:92)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.ReflectiveMethodInvocation</span><span class="variable">.proceed</span>(ReflectiveMethodInvocation<span class="variable">.java</span>:179)</span><br><span class="line">	at org<span class="variable">.springframework</span><span class="variable">.aop</span><span class="variable">.framework</span><span class="variable">.CglibAopProxy</span>$DynamicAdvisedInterceptor<span class="variable">.intercept</span>(CglibAopProxy<span class="variable">.java</span>:653)</span><br><span class="line">    at ...</span><br><span class="line">Caused by: javax<span class="variable">.net</span><span class="variable">.ssl</span><span class="variable">.SSLHandshakeException</span>: Received fatal alert: handshake_failure</span><br><span class="line">	at sun<span class="variable">.security</span><span class="variable">.ssl</span><span class="variable">.Alerts</span><span class="variable">.getSSLException</span>(Alerts<span class="variable">.java</span>:192)</span><br><span class="line">	at sun<span class="variable">.security</span><span class="variable">.ssl</span><span class="variable">.Alerts</span><span class="variable">.getSSLException</span>(Alerts<span class="variable">.java</span>:154)</span><br><span class="line">	at sun<span class="variable">.security</span><span class="variable">.ssl</span><span class="variable">.SSLSocketImpl</span><span class="variable">.recvAlert</span>(SSLSocketImpl<span class="variable">.java</span>:2023)</span><br><span class="line">	at sun<span class="variable">.security</span><span class="variable">.ssl</span><span class="variable">.SSLSocketImpl</span><span class="variable">.readRecord</span>(SSLSocketImpl<span class="variable">.java</span>:1125)</span><br><span class="line">	at sun<span class="variable">.security</span><span class="variable">.ssl</span><span class="variable">.SSLSocketImpl</span><span class="variable">.performInitialHandshake</span>(SSLSocketImpl<span class="variable">.java</span>:1375)</span><br><span class="line">	at sun<span class="variable">.security</span><span class="variable">.ssl</span><span class="variable">.SSLSocketImpl</span><span class="variable">.startHandshake</span>(SSLSocketImpl<span class="variable">.java</span>:1403)</span><br><span class="line">	at sun<span class="variable">.security</span><span class="variable">.ssl</span><span class="variable">.SSLSocketImpl</span><span class="variable">.startHandshake</span>(SSLSocketImpl<span class="variable">.java</span>:1387)</span><br><span class="line">	at com<span class="variable">.sun</span><span class="variable">.mail</span><span class="variable">.util</span><span class="variable">.SocketFetcher</span><span class="variable">.configureSSLSocket</span>(SocketFetcher<span class="variable">.java</span>:549)</span><br><span class="line">	at com<span class="variable">.sun</span><span class="variable">.mail</span><span class="variable">.util</span><span class="variable">.SocketFetcher</span><span class="variable">.createSocket</span>(SocketFetcher<span class="variable">.java</span>:354)</span><br><span class="line">	at com<span class="variable">.sun</span><span class="variable">.mail</span><span class="variable">.util</span><span class="variable">.SocketFetcher</span><span class="variable">.getSocket</span>(SocketFetcher<span class="variable">.java</span>:237)</span><br><span class="line">	at com<span class="variable">.sun</span><span class="variable">.mail</span><span class="variable">.pop</span>3<span class="variable">.Protocol</span>.&lt;init&gt;(Protocol<span class="variable">.java</span>:112)</span><br><span class="line">	at com<span class="variable">.sun</span><span class="variable">.mail</span><span class="variable">.pop</span>3<span class="variable">.POP</span>3Store<span class="variable">.getPort</span>(POP3Store<span class="variable">.java</span>:260)</span><br><span class="line">	at com<span class="variable">.sun</span><span class="variable">.mail</span><span class="variable">.pop</span>3<span class="variable">.POP</span>3Store<span class="variable">.protocolConnect</span>(POP3Store<span class="variable">.java</span>:205)</span><br><span class="line">	... 132 more</span><br><span class="line">[Raw read]: length = 5</span><br><span class="line">0000: 15 03 03 00 02                                     .....</span><br><span class="line">[Raw read]: length = 2</span><br><span class="line">0000: 02 28                                              .(</span><br><span class="line">http-nio-8080-exec-2, READ: TLSv1.2 Alert, length = 2</span><br><span class="line">http-nio-8080-exec-2, RECV TLSv1.2 ALERT:  fatal, handshake_failure</span><br><span class="line">http-nio-8080-exec-2, called closeSocket()</span><br><span class="line">http-nio-8080-exec-2, handling exception: javax<span class="variable">.net</span><span class="variable">.ssl</span><span class="variable">.SSLHandshakeException</span>: Received fatal alert: handshake_failure</span><br></pre></td></tr></table></figure>
<p>注意到：</p>
<blockquote>
<p>Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]</p>
</blockquote>
<p>发现其中果然没有<code>RC4</code>相关的Cipher Suites。</p>
<p>在同事Windows机器上试了以下，输入果然不同，如下：</p>
<blockquote>
<p>Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDHE_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_SHA, TLS_ECDH_ECDSA_WITH_RC4_128_SHA, TLS_ECDH_RSA_WITH_RC4_128_SHA, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_RC4_128_MD5, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]</p>
</blockquote>
<p>赫然发现：SSL_RSA_WITH_RC4_128_SHA。这正是我们想要的东西。</p>
<h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><p>问题找到了，解决办法应该也比较容易找到。查看POP协议相关的<a target="_blank" rel="noopener" href="https://javamail.java.net/nonav/docs/api/com/sun/mail/pop3/package-summary.html">所有参数</a>，找到了<code>mail.pop3.ssl.ciphersuites</code>。在JavaMail的Properties中增加相关的<code>SSL_RSA_WITH_RC4_128_SHA</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.pop3s.ssl.ciphersuites&quot;</span>, <span class="string">&quot;SSL_RSA_WITH_RC4_128_SHA&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>重启服务器，测试，一气呵成，结果：<code>handshake_failure</code></p>
<h3 id="还是系统问题？"><a href="#还是系统问题？" class="headerlink" title="还是系统问题？"></a>还是系统问题？</h3><p>以<code>SSL_RSA_WITH_RC4_128_SHA</code>为关键字搜索，搜到了这篇文章：<a target="_blank" rel="noopener" href="https://support.blancco.com/index.php?/Knowledgebase/Article/View/497/117/java-8-update-60-disables-rc4-cipher-suites-causes-issues-with-blancco-erasure-software-and-mc-3-communication">Java 8 update 60 disables “RC4” cipher suites: Causes issues with Blancco erasure software and MC 3 communication</a>。这是别的软件遇到的问题，但原因是一样的。</p>
<p>原来从JDK 1.8.0_u60开始，默认禁止了RC4这个算法。可以在<code>&#123;JRE_HOME&#125;/lib/security/java.security</code>找到相关配置：</p>
<blockquote>
<p>534 jdk.tls.disabledAlgorithms=SSLv3, RC4, MD5withRSA, DH keySize &lt; 768</p>
</blockquote>
<p>以及</p>
<blockquote>
<p>586 jdk.tls.legacyAlgorithms= <br>587         K_NULL, C_NULL, M_NULL, <br>588         DHE_DSS_EXPORT, DHE_RSA_EXPORT, DH_anon_EXPORT, DH_DSS_EXPORT, <br>589         DH_RSA_EXPORT, RSA_EXPORT, <br>590         DH_anon, ECDH_anon, <br>591         RC4_128, RC4_40, DES_CBC, DES40_CBC</p>
</blockquote>
<p>那Windows中同样的JDK版本，为什么却可以正常使用呢？比较发现在Windows安装之后的Java目录中，有两个部分，一个是JDK目录（其中包含一个JRE目录），一个是直接的JRE目录。打开两个<code>java.security</code>文件，惊奇的发现两个文件并不相同，JRE目录中的<code>java.security</code>并不包含禁用RC4算法这些配置。</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><h4 id="启用Java的RC4算法"><a href="#启用Java的RC4算法" class="headerlink" title="启用Java的RC4算法"></a>启用Java的RC4算法</h4><p>没有去深研究为什么JDK会默认禁止这个算法，也不知道腾讯为什么会重新选择了一个JDK默认禁用的算法（7月29日之前是没有问题的）。但由于需要用到QQ邮箱，所以必须得开启这个算法。开启步骤如下：</p>
<ol>
<li>Go to the Java JRE installation folder: {JRE_HOME}\lib\security\</li>
<li>Locate java.security file.</li>
<li>Make a backup copy of the file.</li>
<li>Edit the java.security file with a text editor software (for example Notepad) according to the example further below.</li>
</ol>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">534c534</span><br><span class="line"><span class="deletion">- jdk.tls.disabledAlgorithms=SSLv3, RC4, MD5withRSA, DH keySize &lt; 768</span></span><br><span class="line"><span class="addition">+ jdk.tls.disabledAlgorithms=SSLv3, MD5withRSA, DH keySize &lt; 768</span></span><br><span class="line">591c591</span><br><span class="line"><span class="deletion">-         RC4_128, RC4_40, DES_CBC, DES40_CBC</span></span><br><span class="line"><span class="addition">+         DES_CBC, DES40_CBC</span></span><br></pre></td></tr></table></figure>

<h4 id="启用协议"><a href="#启用协议" class="headerlink" title="启用协议"></a>启用协议</h4><p>在POP/SMTP的协议中增加最新的TLSv1.2协议：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.pop3s.ssl.protocols&quot;</span>, <span class="string">&quot;TSLv1 TSLv1.1 TLSv1.2&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.smtps.ssl.protocols&quot;</span>, <span class="string">&quot;TSLv1 TSLv1.1 TLSv1.2&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="启用Cipher-Scites"><a href="#启用Cipher-Scites" class="headerlink" title="启用Cipher Scites"></a>启用Cipher Scites</h4><p>因为我需要兼容的不只是RC4这个算法，所以我启用了大部分的Cipher Suites</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.pop3s.ssl.ciphersuites&quot;</span>, <span class="string">&quot;TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA TLS_RSA_WITH_AES_128_CBC_SHA TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA TLS_ECDH_RSA_WITH_AES_128_CBC_SHA TLS_DHE_RSA_WITH_AES_128_CBC_SHA TLS_DHE_DSS_WITH_AES_128_CBC_SHA TLS_ECDHE_ECDSA_WITH_RC4_128_SHA TLS_ECDHE_RSA_WITH_RC4_128_SHA SSL_RSA_WITH_RC4_128_SHA TLS_ECDH_ECDSA_WITH_RC4_128_SHA TLS_ECDH_RSA_WITH_RC4_128_SHA TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA SSL_RSA_WITH_3DES_EDE_CBC_SHA TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA SSL_RSA_WITH_RC4_128_MD5 TLS_EMPTY_RENEGOTIATION_INFO_SCSV&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prop.setProperties(<span class="string">&quot;mail.smtps.ssl.ciphersuites&quot;</span>, <span class="string">&quot;TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA TLS_RSA_WITH_AES_128_CBC_SHA TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA TLS_ECDH_RSA_WITH_AES_128_CBC_SHA TLS_DHE_RSA_WITH_AES_128_CBC_SHA TLS_DHE_DSS_WITH_AES_128_CBC_SHA TLS_ECDHE_ECDSA_WITH_RC4_128_SHA TLS_ECDHE_RSA_WITH_RC4_128_SHA SSL_RSA_WITH_RC4_128_SHA TLS_ECDH_ECDSA_WITH_RC4_128_SHA TLS_ECDH_RSA_WITH_RC4_128_SHA TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA SSL_RSA_WITH_3DES_EDE_CBC_SHA TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA SSL_RSA_WITH_RC4_128_MD5 TLS_EMPTY_RENEGOTIATION_INFO_SCSV&quot;</span>);</span><br></pre></td></tr></table></figure>

<br><hr><b>转载请注明出处：</b><a href="https://www.xiaotanzhu.com/java/2016-07-30-use-rc4-in-tencent-mail.html" target="_blank">RC4被JDK8默认禁用导致腾讯QQ邮箱无法访问</a><br><b>原文地址：</b>https://www.xiaotanzhu.com/java/2016-07-30-use-rc4-in-tencent-mail.html
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/javamail/" rel="tag"># JavaMail</a>
              <a href="/tags/jdk/" rel="tag"># JDK</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/linux/2016-07-26-find-high-cpu-thread.html" rel="prev" title="在生产环境中查出占用大量CPU的Java线程">
                  <i class="fa fa-chevron-left"></i> 在生产环境中查出占用大量CPU的Java线程
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/2016-07-30-monitor-nginx-with-zabbix.html" rel="next" title="使用zabbix监控Nginx">
                  使用zabbix监控Nginx <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2012 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fify</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.wangjingfei.com/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.wangjingfei.com/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.wangjingfei.com/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdn.wangjingfei.com/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"jNm9RvVK687BefTDdg0tXgvf-MdYXbMMI","app_key":"7ejdgq34iVUrKwhqPjLYqAQX","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script src="https://cdn.wangjingfei.com/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '16px',
  right: '20px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaotanzhu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
