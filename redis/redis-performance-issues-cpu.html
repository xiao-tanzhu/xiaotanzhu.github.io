<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.wangjingfei.com/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.wangjingfei.com/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.wangjingfei.com/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.xiaotanzhu.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="解码Redis的最易被忽视的CPU和内存占用高问题">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis常见的CPU和内存性能问题">
<meta property="og:url" content="https://www.xiaotanzhu.com/redis/redis-performance-issues-cpu.html">
<meta property="og:site_name" content="小炭猪">
<meta property="og:description" content="解码Redis的最易被忽视的CPU和内存占用高问题">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.xiaotanzhu.com/images/0001.png">
<meta property="og:image" content="https://www.xiaotanzhu.com/images/0002.png">
<meta property="og:image" content="https://www.xiaotanzhu.com/images/0003.png">
<meta property="og:image" content="https://www.xiaotanzhu.com/images/0004.png">
<meta property="article:published_time" content="2021-03-06T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-06T16:00:00.000Z">
<meta property="article:author" content="Fify">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="Redis Performance">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.xiaotanzhu.com/images/0001.png">


<link rel="canonical" href="https://www.xiaotanzhu.com/redis/redis-performance-issues-cpu.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.xiaotanzhu.com/redis/redis-performance-issues-cpu.html","path":"redis/redis-performance-issues-cpu.html","title":"Redis常见的CPU和内存性能问题"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Redis常见的CPU和内存性能问题 | 小炭猪</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139248857-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-139248857-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="小炭猪" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="小炭猪" type="application/rss+xml">
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小炭猪</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一夕一绽一缕芳，一生一叹一痕沙</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-book fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9F%AD%E8%BF%9E%E6%8E%A5%E5%AF%BC%E8%87%B4-CPU-%E9%AB%98"><span class="nav-number">1.</span> <span class="nav-text">短连接导致 CPU 高</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%94%E5%AE%9E%E9%AA%8C"><span class="nav-number">1.1.</span> <span class="nav-text">对比实验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%95%BF%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95"><span class="nav-number">1.1.1.</span> <span class="nav-text">长连接测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9F%AD%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95"><span class="nav-number">1.1.2.</span> <span class="nav-text">短连接测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-%E8%BF%9E%E6%8E%A5%E9%87%8A%E6%94%BE"><span class="nav-number">1.2.</span> <span class="nav-text">Redis 连接释放</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96"><span class="nav-number">1.3.</span> <span class="nav-text">优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E5%90%8E%E7%9F%AD%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95"><span class="nav-number">1.3.1.</span> <span class="nav-text">优化后短连接测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#info-%E5%91%BD%E4%BB%A4%E5%AF%BC%E8%87%B4-CPU-%E9%AB%98"><span class="nav-number">2.</span> <span class="nav-text">info 命令导致 CPU 高</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C"><span class="nav-number">2.1.</span> <span class="nav-text">实验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%EF%BC%8C%E4%B8%8D%E6%96%AD%E6%89%A7%E8%A1%8C-info-%E5%91%BD%E4%BB%A4"><span class="nav-number">2.1.1.</span> <span class="nav-text">建立一个连接，不断执行 info 命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-9999-%E4%B8%AA%E7%A9%BA%E9%97%B2%E8%BF%9E%E6%8E%A5%EF%BC%8C%E5%8F%8A%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5%E4%B8%8D%E6%96%AD%E6%89%A7%E8%A1%8C-info"><span class="nav-number">2.1.2.</span> <span class="nav-text">建立 9999 个空闲连接，及一个连接不断执行 info</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pipeline-%E5%AF%BC%E8%87%B4%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E9%AB%98"><span class="nav-number">3.</span> <span class="nav-text">pipeline 导致内存占用高</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">小结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Fify"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Fify</p>
  <div class="site-description" itemprop="description">曾经沧海难为水，除却巫山不是云。</br>取次花丛懒回顾，半缘修道半缘君。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">115</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wangjingfei" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangjingfei" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.xiaotanzhu.com/redis/redis-performance-issues-cpu.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Fify">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小炭猪">
      <meta itemprop="description" content="曾经沧海难为水，除却巫山不是云。</br>取次花丛懒回顾，半缘修道半缘君。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Redis常见的CPU和内存性能问题 | 小炭猪">
      <meta itemprop="description" content="解码Redis的最易被忽视的CPU和内存占用高问题">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis常见的CPU和内存性能问题
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-07 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-07T00:00:00+08:00">2021-03-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span id="/redis/redis-performance-issues-cpu.html" class="post-meta-item leancloud_visitors" data-flag-title="Redis常见的CPU和内存性能问题" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">解码Redis的最易被忽视的CPU和内存占用高问题</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://www.infoq.cn/article/yqUuS2qNRybILGrQUliv">https://www.infoq.cn/article/yqUuS2qNRybILGrQUliv</a></p>
</blockquote>
<p>我们在使用 Redis 时，总会碰到一些 redis-server 端 CPU 及内存占用比较高的问题。下面以几个实际案例为例，来讨论一下在使用 Redis 时容易忽视的几种情形。</p>
<h2 id="短连接导致-CPU-高"><a href="#短连接导致-CPU-高" class="headerlink" title="短连接导致 CPU 高"></a>短连接导致 CPU 高</h2><p>某用户反映 QPS 不高，从监控看 CPU 确实偏高。既然 QPS 不高，那么 redis-server 自身很可能在做某些清理工作或者用户在执行复杂度较高的命令，经排查无没有进行 key 过期删除操作，没有执行复杂度高的命令。</p>
<p>上机器对 redis-server 进行 perf 分析，发现函数 listSearchKey 占用 CPU 比较高，分析调用栈发现在释放连接时会频繁调用 listSearchKey，且用户反馈说是使用的短连接，所以推断是频繁释放连接导致 CPU 占用有所升高。</p>
<h3 id="对比实验"><a href="#对比实验" class="headerlink" title="对比实验"></a>对比实验</h3><p>下面使用 redis-benchmark 工具分别使用长连接和短连接做一个对比实验，redis-server 为社区版 4.0.10。</p>
<h4 id="长连接测试"><a href="#长连接测试" class="headerlink" title="长连接测试"></a>长连接测试</h4><p>使用 10000 个长连接向 redis-server 发送 50w 次 ping 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-benchmark -h host -p port -t ping -c 10000 -n 500000 -k 1（k=1表示使用长连接，k=0表示使用短连接)</span><br></pre></td></tr></table></figure>
<p>最终 QPS：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">PING_INLINE</span>: <span class="number">92902</span>.<span class="number">27</span> requests per second</span><br><span class="line"><span class="attribute">PING_BULK</span>: <span class="number">93580</span>.<span class="number">38</span> requests per second</span><br></pre></td></tr></table></figure>
<p>对 redis-server 分析，发现占用 CPU 最高的是 readQueryFromClient，即主要是在处理来自用户端的请求。</p>
<p><img src="/images/0001.png" alt="占用 CPU 最高的是 readQueryFromClient"></p>
<h4 id="短连接测试"><a href="#短连接测试" class="headerlink" title="短连接测试"></a>短连接测试</h4><p>使用 10000 个短连接向 redis-server 发送 50w 次 ping 命令：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-benchmark -h host -p port -<span class="built_in">t</span> ping -c <span class="number">10000</span> -<span class="built_in">n</span> <span class="number">500000</span> -k <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>最终 QPS：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">PING_INLINE</span>: <span class="number">15187</span>.<span class="number">18</span> requests per second</span><br><span class="line"><span class="attribute">PING_BULK</span>: <span class="number">16471</span>.<span class="number">75</span> requests per second</span><br></pre></td></tr></table></figure>
<p>对 redis-server 分析，发现占用 CPU 最高的确实是 listSearchKey，而 readQueryFromClient 所占 CPU 的比例比 listSearchKey 要低得多，也就是说 CPU 有点“不务正业”了，处理用户请求变成了副业，而搜索 list 却成为了主业。所以在同样的业务请求量下，使用短连接会增加 CPU 的负担。</p>
<p><img src="/images/0002.png" alt="使用短连接会增加 CPU 的负担"></p>
<p>从 QPS 上看，短连接与长连接差距比较大，原因来自两方面：</p>
<ul>
<li>每次重新建连接引入的网络开销。</li>
<li>释放连接时，redis-server 需消耗额外的 CPU 周期做清理工作。（这一点可以尝试从 redis-server 端做优化）</li>
</ul>
<h3 id="Redis-连接释放"><a href="#Redis-连接释放" class="headerlink" title="Redis 连接释放"></a>Redis 连接释放</h3><p>我们从代码层面来看下 redis-server 在用户端发起连接释放后都会做哪些事情，redis-server 在收到用户端的断连请求时会直接进入到 freeClient。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">freeClient</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">    listNode *ln;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* .........*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Free the query buffer */</span></span><br><span class="line">    sdsfree(c-&gt;querybuf);</span><br><span class="line">    sdsfree(c-&gt;pending_querybuf);</span><br><span class="line">    c-&gt;querybuf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Deallocate structures used to block on blocking ops. */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;flags &amp; CLIENT_BLOCKED) unblockClient(c);</span><br><span class="line">    dictRelease(c-&gt;bpop.keys);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* UNWATCH all the keys */</span></span><br><span class="line">    unwatchAllKeys(c);</span><br><span class="line">    listRelease(c-&gt;watched_keys);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Unsubscribe from all the pubsub channels */</span></span><br><span class="line">    pubsubUnsubscribeAllChannels(c,<span class="number">0</span>);</span><br><span class="line">    pubsubUnsubscribeAllPatterns(c,<span class="number">0</span>);</span><br><span class="line">    dictRelease(c-&gt;pubsub_channels);</span><br><span class="line">    listRelease(c-&gt;pubsub_patterns);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Free data structures. */</span></span><br><span class="line">    listRelease(c-&gt;reply);</span><br><span class="line">    freeClientArgv(c);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Unlink the client: this will close the socket, remove the I/O</span></span><br><span class="line"><span class="comment">     * handlers, and remove references of the client from different</span></span><br><span class="line"><span class="comment">     * places where active clients may be referenced. */</span></span><br><span class="line">    <span class="comment">/*  redis-server维护了一个server.clients链表，当用户端建立连接后，新建一个client对象并追加到server.clients上，</span></span><br><span class="line"><span class="comment">        当连接释放时，需求从server.clients上删除client对象 */</span></span><br><span class="line">    unlinkClient(c);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* ...........*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlinkClient</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">    listNode *ln;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If this is marked as current client unset it. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.current_client == c) server.current_client = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Certain operations must be done only if the client has an active socket.</span></span><br><span class="line"><span class="comment">     * If the client was already unlinked or if it&#x27;s a &quot;fake client&quot; the</span></span><br><span class="line"><span class="comment">     * fd is already set to -1. */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">/* 搜索server.clients链表，然后删除client节点对象，这里复杂为O(N) */</span></span><br><span class="line">        ln = listSearchKey(server.clients,c);</span><br><span class="line">        serverAssert(ln != <span class="literal">NULL</span>);</span><br><span class="line">        listDelNode(server.clients,ln);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Unregister async I/O handlers and close the socket. */</span></span><br><span class="line">        aeDeleteFileEvent(server.el,c-&gt;fd,AE_READABLE);</span><br><span class="line">        aeDeleteFileEvent(server.el,c-&gt;fd,AE_WRITABLE);</span><br><span class="line">        close(c-&gt;fd);</span><br><span class="line">        c-&gt;fd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*   ......... */</span></span><br></pre></td></tr></table></figure>

<p>所以在每次连接断开时，都存在一个 O(N)的运算。对于 redis 这样的内存数据库，我们应该尽量避开 O(N)运算，特别是在连接数比较大的场景下，对性能影响比较明显。虽然用户只要不使用短连接就能避免，但在实际的场景中，用户端连接池被打满后，用户也可能会建立一些短连接。</p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>从上面的分析看，每次连接释放时都会进行 O(N)的运算，那能不能降复杂度降到 O(1)呢？</p>
<p>这个问题非常简单，server.clients 是个双向链表，只要当 client 对象在创建时记住自己的内存地址，释放时就不需要遍历 server.clients。接下来尝试优化下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">client *<span class="title function_">createClient</span><span class="params">(<span class="type">int</span> fd)</span> &#123;</span><br><span class="line">    client *c = zmalloc(<span class="keyword">sizeof</span>(client));</span><br><span class="line">   <span class="comment">/*  ........  */</span></span><br><span class="line">    listSetFreeMethod(c-&gt;pubsub_patterns,decrRefCountVoid);</span><br><span class="line">    listSetMatchMethod(c-&gt;pubsub_patterns,listMatchObjects);</span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">/*  client记录自身所在list的listNode地址 */</span></span><br><span class="line">        c-&gt;client_list_node = listAddNodeTailEx(server.clients,c);</span><br><span class="line">    &#125;</span><br><span class="line">    initClientMultiState(c);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlinkClient</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">    listNode *ln;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If this is marked as current client unset it. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.current_client == c) server.current_client = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Certain operations must be done only if the client has an active socket.</span></span><br><span class="line"><span class="comment">     * If the client was already unlinked or if it&#x27;s a &quot;fake client&quot; the</span></span><br><span class="line"><span class="comment">     * fd is already set to -1. */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">/* 这时不再需求搜索server.clients链表 */</span></span><br><span class="line">        <span class="comment">//ln = listSearchKey(server.clients,c);</span></span><br><span class="line">        <span class="comment">//serverAssert(ln != NULL);</span></span><br><span class="line">        <span class="comment">//listDelNode(server.clients,ln);</span></span><br><span class="line">        listDelNode(server.clients, c-&gt;client_list_node);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Unregister async I/O handlers and close the socket. */</span></span><br><span class="line">        aeDeleteFileEvent(server.el,c-&gt;fd,AE_READABLE);</span><br><span class="line">        aeDeleteFileEvent(server.el,c-&gt;fd,AE_WRITABLE);</span><br><span class="line">        close(c-&gt;fd);</span><br><span class="line">        c-&gt;fd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*   ......... */</span></span><br></pre></td></tr></table></figure>

<h4 id="优化后短连接测试"><a href="#优化后短连接测试" class="headerlink" title="优化后短连接测试"></a>优化后短连接测试</h4><p>使用 10000 个短连接向 redis-server 发送 50w 次 ping 命令：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-benchmark -h host -p port -<span class="built_in">t</span> ping -c <span class="number">10000</span> -<span class="built_in">n</span> <span class="number">500000</span> -k <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>最终 QPS：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">PING_INLINE</span>: <span class="number">21884</span>.<span class="number">23</span> requests per second</span><br><span class="line"><span class="attribute">PING_BULK</span>: <span class="number">21454</span>.<span class="number">62</span> requests per second</span><br></pre></td></tr></table></figure>
<p>与优化前相比，短连接性能能够提升 30+%，所以能够保证存在短连接的情况下，性能不至于太差。</p>
<h2 id="info-命令导致-CPU-高"><a href="#info-命令导致-CPU-高" class="headerlink" title="info 命令导致 CPU 高"></a>info 命令导致 CPU 高</h2><p>有用户通过定期执行 info 命令监视 redis 的状态，这会在一定程度上导致 CPU 占用偏高。频繁执行 info 时通过 perf 分析发现 getClientsMaxBuffers、getClientOutputBufferMemoryUsage 及 getMemoryOverheadData 这几个函数占用 CPU 比较高。</p>
<p>通过 Info 命令，可以拉取到 redis-server 端的如下一些状态信息（未列全）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">client</span><br><span class="line">connected_clients:<span class="number">1</span></span><br><span class="line">client_longest_output_list:<span class="number">0</span> <span class="comment">// redis-server端最长的outputbuffer列表长度</span></span><br><span class="line">client_biggest_input_buf:<span class="number">0.</span> <span class="comment">// redis-server端最长的inputbuffer字节长度</span></span><br><span class="line">blocked_clients:<span class="number">0</span></span><br><span class="line">Memory</span><br><span class="line">used_memory:<span class="number">848392</span></span><br><span class="line">used_memory_human:<span class="number">828.51</span>K</span><br><span class="line">used_memory_rss:<span class="number">3620864</span></span><br><span class="line">used_memory_rss_human:<span class="number">3.45</span>M</span><br><span class="line">used_memory_peak:<span class="number">619108296</span></span><br><span class="line">used_memory_peak_human:<span class="number">590.43</span>M</span><br><span class="line">used_memory_peak_perc:<span class="number">0.14</span>%</span><br><span class="line">used_memory_overhead:<span class="number">836182</span> <span class="comment">// 除dataset外，redis-server为维护自身结构所额外占用的内存量</span></span><br><span class="line">used_memory_startup:<span class="number">786552</span></span><br><span class="line">used_memory_dataset:<span class="number">12210</span></span><br><span class="line">used_memory_dataset_perc:<span class="number">19.74</span>%</span><br><span class="line">为了得到client_longest_output_list、client_longest_output_list状态，需要遍历redis-server端所有的client, 如getClientsMaxBuffers所示，可能看到这里也是存在同样的O(N)运算。</span><br><span class="line"><span class="type">void</span> <span class="title function_">getClientsMaxBuffers</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> *longest_output_list,</span></span><br><span class="line"><span class="params">                          <span class="type">unsigned</span> <span class="type">long</span> *biggest_input_buffer)</span> &#123;</span><br><span class="line">    client *c;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> lol = <span class="number">0</span>, bib = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* 遍历所有client, 复杂度O(N) */</span></span><br><span class="line">    listRewind(server.clients,&amp;li);</span><br><span class="line">    <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        c = listNodeValue(ln);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (listLength(c-&gt;reply) &gt; lol) lol = listLength(c-&gt;reply);</span><br><span class="line">        <span class="keyword">if</span> (sdslen(c-&gt;querybuf) &gt; bib) bib = sdslen(c-&gt;querybuf);</span><br><span class="line">    &#125;</span><br><span class="line">    *longest_output_list = lol;</span><br><span class="line">    *biggest_input_buffer = bib;</span><br><span class="line">&#125;</span><br><span class="line">为了得到used_memory_overhead状态，同样也需要遍历所有client计算所有client的outputBuffer所占用的内存总量，如getMemoryOverheadData所示：</span><br><span class="line"><span class="keyword">struct</span> redisMemOverhead *<span class="title function_">getMemoryOverheadData</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ......... */</span></span><br><span class="line">    mem = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (server.repl_backlog)</span><br><span class="line">        mem += zmalloc_size(server.repl_backlog);</span><br><span class="line">    mh-&gt;repl_backlog = mem;</span><br><span class="line">    mem_total += mem;</span><br><span class="line">   <span class="comment">/* ...............*/</span></span><br><span class="line">    mem = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (listLength(server.clients)) &#123;</span><br><span class="line">        listIter li;</span><br><span class="line">        listNode *ln;</span><br><span class="line">        <span class="comment">/*  遍历所有的client, 计算所有client outputBuffer占用的内存总和，复杂度为O(N)  */</span></span><br><span class="line">        listRewind(server.clients,&amp;li);</span><br><span class="line">        <span class="keyword">while</span>((ln = listNext(&amp;li))) &#123;</span><br><span class="line">            client *c = listNodeValue(ln);</span><br><span class="line">            <span class="keyword">if</span> (c-&gt;flags &amp; CLIENT_SLAVE)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            mem += getClientOutputBufferMemoryUsage(c);</span><br><span class="line">            mem += sdsAllocSize(c-&gt;querybuf);</span><br><span class="line">            mem += <span class="keyword">sizeof</span>(client);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mh-&gt;clients_normal = mem;</span><br><span class="line">    mem_total+=mem;</span><br><span class="line"></span><br><span class="line">    mem = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (server.aof_state != AOF_OFF) &#123;</span><br><span class="line">        mem += sdslen(server.aof_buf);</span><br><span class="line">        mem += aofRewriteBufferSize();</span><br><span class="line">    &#125;</span><br><span class="line">    mh-&gt;aof_buffer = mem;</span><br><span class="line">    mem_total+=mem;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* ......... */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><p>从上面的分析知道，当连接数较高时（O(N)的 N 大），如果频率执行 info 命令，会占用较多 CPU。</p>
<h4 id="建立一个连接，不断执行-info-命令"><a href="#建立一个连接，不断执行-info-命令" class="headerlink" title="建立一个连接，不断执行 info 命令"></a>建立一个连接，不断执行 info 命令</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">     c, err := redis.Dial(<span class="string">&quot;tcp&quot;</span>, addr)</span><br><span class="line">     <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Connect to redis error:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">for</span> &#123;</span><br><span class="line">        c.Do(<span class="string">&quot;info&quot;</span>)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实验结果表明，CPU 占用仅为 20%左右。</p>
<p><img src="/images/0003.png" alt="CPU 占用仅为 20%左右"></p>
<h4 id="建立-9999-个空闲连接，及一个连接不断执行-info"><a href="#建立-9999-个空闲连接，及一个连接不断执行-info" class="headerlink" title="建立 9999 个空闲连接，及一个连接不断执行 info"></a>建立 9999 个空闲连接，及一个连接不断执行 info</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">     clients := []redis.Conn&#123;&#125;</span><br><span class="line">     <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">9999</span>; i++ &#123;</span><br><span class="line">        c, err := redis.Dial(<span class="string">&quot;tcp&quot;</span>, addr)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">           fmt.Println(<span class="string">&quot;Connect to redis error:&quot;</span>, err)</span><br><span class="line">           <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        clients = <span class="built_in">append</span>(clients, c)</span><br><span class="line">     &#125;</span><br><span class="line">     c, err := redis.Dial(<span class="string">&quot;tcp&quot;</span>, addr)</span><br><span class="line">     <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Connect to redis error:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">for</span> &#123;</span><br><span class="line">        _, err = c.Do(<span class="string">&quot;info&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">           <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实验结果表明 CPU 能够达到 80%，所以在连接数较高时，尽量避免使用 info 命令。</p>
<p><img src="/images/0004.png" alt="CPU 能够达到 80%"></p>
<h2 id="pipeline-导致内存占用高"><a href="#pipeline-导致内存占用高" class="headerlink" title="pipeline 导致内存占用高"></a>pipeline 导致内存占用高</h2><p>有用户发现在使用 pipeline 做只读操作时，redis-server 的内存容量偶尔也会出现明显的上涨, 这是对 pipeline 的使不当造成的。下面先以一个简单的例子来说明 Redis 的 pipeline 逻辑是怎样的。</p>
<p>下面通过 golang 语言实现以 pipeline 的方式从 redis-server 端读取 key1、key2、key3。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/garyburd/redigo/redis&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    c, err := redis.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:6379&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    c.Send(<span class="string">&quot;get&quot;</span>, <span class="string">&quot;key1&quot;</span>)       <span class="comment">//缓存到client端的buffer中</span></span><br><span class="line">    c.Send(<span class="string">&quot;get&quot;</span>, <span class="string">&quot;key2&quot;</span>)       <span class="comment">//缓存到client端的buffer中</span></span><br><span class="line">    c.Send(<span class="string">&quot;get&quot;</span>, <span class="string">&quot;key3&quot;</span>)       <span class="comment">//缓存到client端的buffer中</span></span><br><span class="line">    c.Flush()                   <span class="comment">//将buffer中的内容以一特定的协议格式发送到redis-server端</span></span><br><span class="line">    fmt.Println(redis.String(c.Receive()))</span><br><span class="line">    fmt.Println(redis.String(c.Receive()))</span><br><span class="line">    fmt.Println(redis.String(c.Receive()))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而此时 server 端收到的内容为：</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*<span class="number">2</span>\r\n$<span class="number">3</span>\r\nget\r\n$<span class="number">4</span>\r\nkey1\r\n*<span class="number">2</span>\r\n$<span class="number">3</span>\r\nget\r\n$<span class="number">4</span>\r\nkey2\r\n*<span class="number">2</span>\r\n$<span class="number">3</span>\r\nget\r\n$<span class="number">4</span>\r\nkey3\r\n</span><br></pre></td></tr></table></figure>

<p>下面是一段 redis-server 端非正式的代码处理逻辑，redis-server 端从接收到的内容依次解析出命令、执行命令、将执行结果缓存到 replyBuffer 中，并将用户端标记为有内容需要写出。等到下次事件调度时再将 replyBuffer 中的内容通过 socket 发送到 client，所以并不是处理完一条命令就将结果返回用户端。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">readQueryFromClient(client* c) &#123;</span><br><span class="line">    read(c-&gt;querybuf) <span class="comment">// c-&gt;query=&quot;*2\r\n$3\r\nget\r\n$4\r\nkey1\r\n*2\r\n$3\r\nget\r\n$4\r\nkey2\r\n*2\r\n$3\r\nget\r\n$4\r\nkey3\r\n&quot;</span></span><br><span class="line">    cmdsNum = parseCmdNum(c-&gt;querybuf)  <span class="comment">// cmdNum = 3</span></span><br><span class="line">    <span class="keyword">while</span>(cmsNum--) &#123;</span><br><span class="line">        cmd = parseCmd(c-&gt;querybuf)    <span class="comment">// cmd:  get key1、get key2、get key3</span></span><br><span class="line">        reply = execCmd(cmd)</span><br><span class="line">        appendReplyBuffer(reply)</span><br><span class="line">        markClientPendingWrite(c)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>考虑这样一种情况：</p>
<p>如果用户端程序处理比较慢，未能及时通过 c.Receive()从 TCP 的接收 buffer 中读取内容或者因为某些 BUG 导致没有执行 c.Receive()，当接收 buffer 满了后，server 端的 TCP 滑动窗口为 0，导致 server 端无法发送 replyBuffer 中的内容，所以 replyBuffer 由于迟迟得不到释放而占用额外的内存。当 pipeline 一次打包的命令数太多，以及包含如 mget、hgetall、lrange 等操作多个对象的命令时，问题会更突出。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>上面几种情况，都是非常简单的问题，没有复杂的逻辑，在大部分场景下都不算问题，但是在一些极端场景下要把 Redis 用好，开发者还是需要关注这些细节。建议：</p>
<ul>
<li>尽量不要使用短连接；</li>
<li>尽量不要在连接数比较高的场景下频繁使用 info；</li>
<li>使用 pipeline 时，要及时接收请求处理结果，且 pipeline 不宜一次打包太多请求。</li>
</ul>
<hr>
<blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://www.infoq.cn/article/yqUuS2qNRybILGrQUliv">https://www.infoq.cn/article/yqUuS2qNRybILGrQUliv</a></p>
</blockquote>
<br><hr><b>转载请注明出处：</b><a href="https://www.xiaotanzhu.com/redis/redis-performance-issues-cpu.html" target="_blank">Redis常见的CPU和内存性能问题</a><br><b>原文地址：</b>https://www.xiaotanzhu.com/redis/redis-performance-issues-cpu.html
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"># Redis</a>
              <a href="/tags/redis-performance/" rel="tag"># Redis Performance</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E8%BF%90%E7%BB%B4/ansible-commands.html" rel="prev" title="Ansible常用命令">
                  <i class="fa fa-chevron-left"></i> Ansible常用命令
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/linux/linux-command-find-howtos.html" rel="next" title="Linux find命令高阶用法">
                  Linux find命令高阶用法 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2012 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fify</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.wangjingfei.com/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.wangjingfei.com/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.wangjingfei.com/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdn.wangjingfei.com/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"jNm9RvVK687BefTDdg0tXgvf-MdYXbMMI","app_key":"7ejdgq34iVUrKwhqPjLYqAQX","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script src="https://cdn.wangjingfei.com/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '16px',
  right: '20px',
  left: 'unset',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"xiaotanzhu","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
